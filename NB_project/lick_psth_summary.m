function lick_psth_summary
%LICK_PSTH_SUMMARY   Average lick PETH.
%   LICK_PSTH_SUMMARY plots average lick PETH (beam break time stamps
%   aligned to an event). 10 last sessions from mice with no feedback
%   training (but enough training history) are used: 60 sessions from 6
%   mice.
%
%   See also ULTIMATE_PSTH.

% Directories
global DATAPATH
resdir = ([DATAPATH 'NB\lick_psth\']);   % result directory
issave = true;

% Sessions: 6 mice w no feedback delay that had enough training - last 10
% sessions (only first sessions if there were more per day)
cellids = {...
    'n013' '110630a';...
    'n013' '110701a';...
    'n013' '110704a';...
    'n013' '110705a';...
    'n013' '110706a';...
    'n013' '110707a';...
    'n013' '110708a';...
    'n013' '110709a';...
    'n013' '110715a';...
    'n013' '110716a';...
    'n023' '120210a';...
    'n023' '120211a';...
    'n023' '120213a';...
    'n023' '120214a';...
    'n023' '120215a';...
    'n023' '120216a';...
    'n023' '120217a';...
    'n023' '120220a';...
    'n023' '120221a';...
    'n023' '120222a';...
    'n026' '120215a';...
    'n026' '120216a';...
    'n026' '120217a';...
    'n026' '120218a';...
    'n026' '120220a';...
    'n026' '120221a';...
    'n026' '120222a';...
    'n026' '120223a';...
    'n026' '120301a';...
    'n026' '120303a';...
    'n027' '120305a';...
    'n027' '120306a';...
    'n027' '120307a';...
    'n027' '120308a';...
    'n027' '120309a';...
    'n027' '120310a';...
    'n027' '120311a';...
    'n027' '120313a';...
    'n027' '120314a';...
    'n027' '120315a';...
    'n028' '120220a';...
    'n028' '120221a';...
    'n028' '120222a';...
    'n028' '120223a';...
    'n028' '120301a';...
    'n028' '120302a';...
    'n028' '120303a';...
    'n028' '120305a';...
    'n028' '120306a';...
    'n028' '120307a';...
    'n029' '120305a';...
    'n029' '120306a';...
    'n029' '120307a';...
    'n029' '120308a';...
    'n029' '120309a';...
    'n029' '120310a';...
    'n029' '120311a';...
    'n029' '120313a';...
    'n029' '120314a';...
    'n029' '120315a'};

% PETH
NumSessions = size(cellids,1);   % number of sessions
[Hit_allpsth FA_allpsth] = deal([]);
for iS = 1:NumSessions
    cellid = cellids(iS,:);
    [spsth_hit spsth_fa] = main(cellid);
    Hit_allpsth = [Hit_allpsth; spsth_hit]; %#ok<*AGROW>
    FA_allpsth = [FA_allpsth; spsth_fa]; %#ok<*AGROW>
    H = gcf;
    if issave
        cellidt = [cellid{1} '_' cellid{2}];
        fnm = [resdir cellidt '_LICK.fig'];   % save
        saveas(H,fnm)
        fnm = [resdir cellidt '_LICK.jpg'];
        saveas(H,fnm)
    end
    close(H)
end

% Time window
wn = [-2 2];   % in seconds
dt = 0.001;   % resolution, in seconds
time = wn(1):dt:wn(2);   % time vector

% Plot
H = figure;
green = [51 204 51] / 255;   % colors for plotting
red = [216 41 0] / 255;
errorshade(time,mean(Hit_allpsth),std(Hit_allpsth)/sqrt(size(Hit_allpsth,1)),...
    'LineColor',green,'ShadeColor',green)
hold on
errorshade(time,mean(FA_allpsth),std(FA_allpsth)/sqrt(size(FA_allpsth,1)),...
    'LineColor',red,'ShadeColor',red)
if issave
    fnm = fullfile(resdir,'average_lickPSTH.fig');
    saveas(H,fnm)
end

% -------------------------------------------------------------------------
function [spsth_hit spsth_fa] = main(cellid)

% align_event = 'StimulusOn';
% align_event = 'DeliverFeedback';
align_event_fa = 'LeftPortIn';
align_event_hit = 'LeftPortIn';

% Time window
wn = [-2 2];   % in seconds
dt = 0.001;   % resolution, in seconds
time = wn(1):dt:wn(2);   % time vector

% Calcualte PSTH
[psth, spsth_hit, spsth_se, ~, spt] = ...
    ultimate_psth(cellid,'lick',align_event_hit,wn,...
    'dt',dt,'sigma',0.02,'event_filter','custom','filterinput','Hit==1',...
    'isadaptive',0,'maxtrialno',Inf);
[psth, spsth_fa, spsth_se, ~, spt] = ...
    ultimate_psth(cellid,'lick',align_event_fa,wn,...
    'dt',dt,'sigma',0.02,'event_filter','custom','filterinput','FalseAlarm==1',...
    'isadaptive',0,'maxtrialno',Inf);

% Lick raster
H = figure;
viewlick(cellid,'TriggerName',align_event_fa,'SortEvent','TrialStart','eventtype','behav',...
    'ShowEvents',{{'StimulusOn' 'StimulusOff'}},...
    'Partitions','#ResponseType','window',[-5 5])
maximize_figure(H)